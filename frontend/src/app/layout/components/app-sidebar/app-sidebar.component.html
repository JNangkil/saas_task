<nav class="sidebar">
  <div class="sidebar__brand-wrapper" [class.sidebar__brand-wrapper--open]="isBrandMenuOpen()">
    <button
      #brandTrigger
      class="sidebar__brand"
      type="button"
      [class.sidebar__brand--empty]="!activeWorkspace()"
      (click)="toggleWorkspaceMenu()"
      [attr.aria-expanded]="isBrandMenuOpen()"
      aria-haspopup="true"
    >
      <div class="sidebar__brand-mark">
        {{ workspaceInitials(activeWorkspace()?.name || 'TaskFlow') }}
      </div>
      <div class="sidebar__brand-copy">
        <span class="sidebar__brand-name">
          {{ activeWorkspace()?.name || 'TaskFlow' }}
        </span>
        <span class="sidebar__brand-plan">
          {{ activeWorkspace() ? 'Workspace' : 'Select a workspace' }}
        </span>
      </div>
      <span class="sidebar__brand-caret" aria-hidden="true"></span>
    </button>

    <div
      #brandMenu
      class="sidebar__brand-menu"
      *ngIf="isBrandMenuOpen()"
      role="menu"
      (keydown)="handleWorkspaceMenuKeydown($event)"
    >
      <p class="sidebar__brand-menu-title">Workspace controls</p>
      <ul class="sidebar__brand-menu-list">
        <li *ngFor="let action of workspaceActions">
          <button
            type="button"
            class="sidebar__brand-menu-item"
            [class.is-active]="action.section === activeWorkspaceSection()"
            (click)="navigateWorkspaceSection(action.section)"
            role="menuitem"
          >
            <span class="sidebar__brand-menu-icon">{{ action.icon }}</span>
            <span class="sidebar__brand-menu-text">
              <span class="sidebar__brand-menu-label">{{ action.label }}</span>
              <span class="sidebar__brand-menu-description">{{ action.description }}</span>
            </span>
          </button>
        </li>
      </ul>
    </div>
  </div>

  <div class="sidebar__user" *ngIf="user$ | async as user">
    <tf-avatar class="sidebar__avatar" [name]="user.displayName || user.email"></tf-avatar>
    <div class="sidebar__user-meta">
      <span class="sidebar__user-name">{{ user.displayName || user.email }}</span>
      <span class="sidebar__user-role">{{ user.roles[0] || 'Member' }}</span>
    </div>
  </div>

  <section class="sidebar__section sidebar__section--workspaces" *ngIf="workspaces().length; else emptyState">
    <div class="sidebar__section-header">
      <h2 class="sidebar__section-title">Workspaces</h2>
      <button type="button" class="sidebar__section-action" (click)="openWorkspaceCreation()">
        New
      </button>
    </div>

    <ul class="sidebar__nav sidebar__nav--workspaces">
      <li *ngFor="let workspace of workspaces(); trackBy: trackByWorkspaceId">
        <a
          class="sidebar__nav-link"
          [routerLink]="['/workspace', workspace.id, 'overview']"
          [class.is-active]="workspace.id === activeWorkspaceId()"
          (click)="selectWorkspace(workspace)"
        >
          <span class="sidebar__nav-icon" aria-hidden="true">
            {{ workspaceInitials(workspace.name) }}
          </span>
          <span class="sidebar__nav-label">{{ workspace.name }}</span>
        </a>
      </li>
    </ul>
  </section>

  <section class="sidebar__section sidebar__section--structure" *ngIf="activeWorkspace()">
    <div class="sidebar__section-header">
      <h2 class="sidebar__section-title">Structure</h2>
    </div>

    <tf-workspace-structure-tree></tf-workspace-structure-tree>
  </section>
  <ng-template #emptyState>
    <section class="sidebar__section sidebar__section--empty">
      <div class="sidebar__section-header">
        <h2 class="sidebar__section-title">Workspaces</h2>
        <button type="button" class="sidebar__section-action" (click)="openWorkspaceCreation()">
          New
        </button>
      </div>
      <p class="sidebar__empty-copy">
        No workspaces yet. Create one to get started.
      </p>
      <button type="button" class="sidebar__primary-button" (click)="openWorkspaceCreation()">
        Create workspace
      </button>
    </section>
  </ng-template>
</nav>
